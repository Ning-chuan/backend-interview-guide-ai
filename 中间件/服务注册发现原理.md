# æœåŠ¡æ³¨å†Œä¸å‘ç°åŸç†æ·±åº¦è§£æ

## ğŸ¯ å­¦ä¹ ç›®æ ‡
- æ·±å…¥ç†è§£æœåŠ¡æ³¨å†Œä¸å‘ç°çš„å·¥ä½œåŸç†
- æŒæ¡Eurekaçš„æ ¸å¿ƒæœºåˆ¶å’Œå®¹é”™ç­–ç•¥
- å¯¹æ¯”ä¸åŒæ³¨å†Œä¸­å¿ƒçš„ä¼˜ç¼ºç‚¹
- èƒ½å¤Ÿå‡†ç¡®æè¿°æœåŠ¡å‘ç°çš„å®Œæ•´æµç¨‹

## ğŸ“– æ ¸å¿ƒæ¦‚å¿µ

### 1. ä»€ä¹ˆæ˜¯æœåŠ¡æ³¨å†Œä¸å‘ç°ï¼Ÿ

**æœåŠ¡æ³¨å†Œ**ï¼šæœåŠ¡å¯åŠ¨æ—¶ï¼Œå°†è‡ªå·±çš„ä¿¡æ¯ï¼ˆæœåŠ¡åã€IPåœ°å€ã€ç«¯å£ç­‰ï¼‰æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ

**æœåŠ¡å‘ç°**ï¼šå®¢æˆ·ç«¯ä»æ³¨å†Œä¸­å¿ƒè·å–æœåŠ¡æä¾›è€…çš„ä¿¡æ¯ï¼Œç„¶åè¿›è¡Œè¿œç¨‹è°ƒç”¨

**æ ¸å¿ƒä»·å€¼**ï¼š
- è§£è€¦æœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…
- æ”¯æŒæœåŠ¡çš„åŠ¨æ€æ‰©å®¹ç¼©å®¹
- æä¾›è´Ÿè½½å‡è¡¡å’Œæ•…éšœè½¬ç§»èƒ½åŠ›

### 2. æœåŠ¡æ³¨å†Œä¸å‘ç°æ¶æ„æ¨¡å¼

#### 2.1 å®¢æˆ·ç«¯å‘ç°æ¨¡å¼ï¼ˆEurekaé‡‡ç”¨ï¼‰
```
æœåŠ¡å®ä¾‹ -> æ³¨å†Œä¸­å¿ƒ (æ³¨å†Œ)
å®¢æˆ·ç«¯ -> æ³¨å†Œä¸­å¿ƒ (æŸ¥è¯¢) -> å®¢æˆ·ç«¯ç¼“å­˜
å®¢æˆ·ç«¯ -> æœåŠ¡å®ä¾‹ (ç›´æ¥è°ƒç”¨)
```

**ä¼˜ç‚¹**ï¼š
- å®¢æˆ·ç«¯å¯ä»¥è‡ªä¸»é€‰æ‹©è´Ÿè½½å‡è¡¡ç­–ç•¥
- æ€§èƒ½å¥½ï¼Œå‡å°‘ä¸­é—´ç¯èŠ‚
- ç½‘ç»œæ‹“æ‰‘ç›¸å¯¹ç®€å•

**ç¼ºç‚¹**ï¼š
- å®¢æˆ·ç«¯é€»è¾‘å¤æ‚
- å®¢æˆ·ç«¯ä¸æ³¨å†Œä¸­å¿ƒè€¦åˆ

#### 2.2 æœåŠ¡ç«¯å‘ç°æ¨¡å¼ï¼ˆK8s Serviceé‡‡ç”¨ï¼‰
```
æœåŠ¡å®ä¾‹ -> æ³¨å†Œä¸­å¿ƒ (æ³¨å†Œ)
å®¢æˆ·ç«¯ -> è´Ÿè½½å‡è¡¡å™¨ -> æ³¨å†Œä¸­å¿ƒ (æŸ¥è¯¢)
è´Ÿè½½å‡è¡¡å™¨ -> æœåŠ¡å®ä¾‹ (ä»£ç†è°ƒç”¨)
```

**ä¼˜ç‚¹**ï¼š
- å®¢æˆ·ç«¯é€»è¾‘ç®€å•
- è´Ÿè½½å‡è¡¡é›†ä¸­ç®¡ç†
- æœåŠ¡å‘ç°é€»è¾‘å¯¹å®¢æˆ·ç«¯é€æ˜

**ç¼ºç‚¹**ï¼š
- è´Ÿè½½å‡è¡¡å™¨å¯èƒ½æˆä¸ºç“¶é¢ˆ
- ç½‘ç»œè·³æ•°å¢åŠ 

## ğŸ”§ Eureka æ·±åº¦å‰–æ

### 1. Eureka æ¶æ„ç»„ä»¶

#### 1.1 Eureka Serverï¼ˆæ³¨å†Œä¸­å¿ƒï¼‰
```java
@SpringBootApplication
@EnableEurekaServer
public class EurekaServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(EurekaServerApplication.class, args);
    }
}
```

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- æ¥æ”¶æœåŠ¡æ³¨å†Œè¯·æ±‚
- ç»´æŠ¤æœåŠ¡å®ä¾‹æ³¨å†Œè¡¨
- æä¾›æœåŠ¡å‘ç°æ¥å£
- æœåŠ¡å®ä¾‹å¥åº·æ£€æŸ¥
- é›†ç¾¤æ•°æ®åŒæ­¥

#### 1.2 Eureka Clientï¼ˆæœåŠ¡æä¾›è€…/æ¶ˆè´¹è€…ï¼‰
```java
@SpringBootApplication
@EnableEurekaClient
public class ServiceProviderApplication {
    public static void main(String[] args) {
        SpringApplication.run(ServiceProviderApplication.class, args);
    }
}
```

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- æœåŠ¡æ³¨å†Œåˆ°Eureka Server
- å®šæœŸå‘é€å¿ƒè·³ä¿æŒæ³¨å†Œ
- ä»Eureka Serverè·å–æ³¨å†Œä¿¡æ¯
- ç¼“å­˜æ³¨å†Œä¿¡æ¯åˆ°æœ¬åœ°

### 2. Eureka å®Œæ•´å·¥ä½œæµç¨‹

#### 2.1 æœåŠ¡æ³¨å†Œæµç¨‹

```mermaid
sequenceDiagram
    participant Client as Service Instance
    participant Server as Eureka Server
    participant Registry as Service Registry
    
    Client->>Server: 1. æœåŠ¡æ³¨å†Œè¯·æ±‚ (POST /apps/{appName})
    Server->>Registry: 2. å­˜å‚¨æœåŠ¡å®ä¾‹ä¿¡æ¯
    Server->>Client: 3. è¿”å›æ³¨å†ŒæˆåŠŸå“åº”
    
    loop å¿ƒè·³ä¿æŒ
        Client->>Server: 4. å‘é€å¿ƒè·³ (PUT /apps/{appName}/{instanceId})
        Server->>Registry: 5. æ›´æ–°æœ€åå¿ƒè·³æ—¶é—´
        Server->>Client: 6. è¿”å›å¿ƒè·³å“åº”
    end
```

**è¯¦ç»†æ­¥éª¤**ï¼š

1. **æœåŠ¡å¯åŠ¨æ³¨å†Œ**
```java
// æœåŠ¡å®ä¾‹ä¿¡æ¯
InstanceInfo instanceInfo = InstanceInfo.Builder.newBuilder()
    .setAppName("user-service")
    .setInstanceId("user-service-001")
    .setHostName("192.168.1.100")
    .setPort(8080)
    .setVIPAddress("user-service")
    .setStatus(InstanceStatus.UP)
    .build();

// å‘é€æ³¨å†Œè¯·æ±‚åˆ°Eureka Server
eurekaClient.registerInstance(instanceInfo);
```

2. **å®šæœŸå‘é€å¿ƒè·³**
```java
// é»˜è®¤æ¯30ç§’å‘é€ä¸€æ¬¡å¿ƒè·³
@Scheduled(fixedRate = 30000)
public void sendHeartbeat() {
    eurekaClient.sendHeartbeat(appName, instanceId);
}
```

#### 2.2 æœåŠ¡å‘ç°æµç¨‹

```mermaid
sequenceDiagram
    participant Consumer as Service Consumer
    participant Server as Eureka Server
    participant Cache as Local Cache
    participant Provider as Service Provider
    
    Consumer->>Server: 1. è·å–æœåŠ¡åˆ—è¡¨ (GET /apps/{appName})
    Server->>Consumer: 2. è¿”å›æœåŠ¡å®ä¾‹åˆ—è¡¨
    Consumer->>Cache: 3. ç¼“å­˜åˆ°æœ¬åœ°
    
    loop å®šæœŸæ›´æ–°ç¼“å­˜
        Consumer->>Server: 4. å¢é‡è·å–æ›´æ–° (GET /apps/delta)
        Server->>Consumer: 5. è¿”å›å˜æ›´ä¿¡æ¯
        Consumer->>Cache: 6. æ›´æ–°æœ¬åœ°ç¼“å­˜
    end
    
    Consumer->>Cache: 7. ä»æœ¬åœ°ç¼“å­˜è·å–æœåŠ¡å®ä¾‹
    Consumer->>Provider: 8. è´Ÿè½½å‡è¡¡åè°ƒç”¨æœåŠ¡
```

**è¯¦ç»†å®ç°**ï¼š

1. **è·å–æœåŠ¡å®ä¾‹åˆ—è¡¨**
```java
// ä»Eureka Serverè·å–æœåŠ¡åˆ—è¡¨
Applications applications = eurekaClient.getApplications();
Application userService = applications.getRegisteredApplications("USER-SERVICE");
List<InstanceInfo> instances = userService.getInstances();

// è¿‡æ»¤å¥åº·çš„å®ä¾‹
List<InstanceInfo> healthyInstances = instances.stream()
    .filter(instance -> instance.getStatus() == InstanceStatus.UP)
    .collect(Collectors.toList());
```

2. **è´Ÿè½½å‡è¡¡é€‰æ‹©å®ä¾‹**
```java
// è½®è¯¢è´Ÿè½½å‡è¡¡
public class RoundRobinLoadBalancer {
    private AtomicInteger  = new AtomicInteger(0);
    
    public InstanceInfo choose(List<InstanceInfo> instances) {
        if (instances.isEmpty()) {
            return null;
        }
        int index = counter.getAndIncrement() % instances.size();
        return instances.get(index);
    }
}
```

### 3. Eureka æ ¸å¿ƒé…ç½®å‚æ•°

#### 3.1 Serverç«¯é…ç½®
```yaml
eureka:
  server:
    # å…³é—­è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®å¼€å¯ï¼‰
    enable-self-preservation: false
    # æ¸…ç†æ— æ•ˆèŠ‚ç‚¹çš„æ—¶é—´é—´éš”ï¼Œé»˜è®¤60ç§’
    eviction-interval-timer-in-ms: 60000
    # æœŸæœ›æ”¶åˆ°çš„å¿ƒè·³æ•°é˜ˆå€¼ï¼Œä½äºæ­¤å€¼è§¦å‘è‡ªæˆ‘ä¿æŠ¤
    renewal-percent-threshold: 0.85
  instance:
    # æœåŠ¡å™¨ä¸»æœºå
    hostname: eureka-server
```

#### 3.2 Clientç«¯é…ç½®
```yaml
eureka:
  client:
    # æ˜¯å¦å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œè‡ªå·±
    register-with-eureka: true
    # æ˜¯å¦ä»æ³¨å†Œä¸­å¿ƒè·å–æœåŠ¡åˆ—è¡¨
    fetch-registry: true
    # æ³¨å†Œä¸­å¿ƒåœ°å€
    service-url:
      defaultZone: http://localhost:8761/eureka/
    # ä»æ³¨å†Œä¸­å¿ƒæ‹‰å–æœåŠ¡åˆ—è¡¨çš„é—´éš”ï¼Œé»˜è®¤30ç§’
    registry-fetch-interval-seconds: 30
  instance:
    # å¿ƒè·³é—´éš”ï¼Œé»˜è®¤30ç§’
    lease-renewal-interval-in-seconds: 30
    # æœåŠ¡å¤±æ•ˆæ—¶é—´ï¼Œé»˜è®¤90ç§’
    lease-expiration-duration-in-seconds: 90
    # å®ä¾‹ID
    instance-id: ${spring.application.name}:${server.port}
```

### 4. Eureka å®¹é”™æœºåˆ¶

#### 4.1 æœåŠ¡ä¸‹çº¿å»¶è¿Ÿé—®é¢˜åŠå¤„ç†

**é—®é¢˜åœºæ™¯**ï¼šAè°ƒç”¨Bï¼Œå¦‚æœBæŸä¸ªå®ä¾‹ä¸‹çº¿ï¼Œè€ŒAçš„æœ¬åœ°ç¼“å­˜è¿˜æ²¡æœ‰æ›´æ–°ï¼Œè°ƒç”¨çš„æ—¶å€™è´Ÿè½½å‡è¡¡ç­–ç•¥æ­£å¥½é€‰ä¸­äº†è¿™ä¸ªä¸‹çº¿çš„æœåŠ¡ã€‚

**è¿™ç§æƒ…å†µç¡®å®ä¼šå‡ºç°ï¼ŒåŸå› å¦‚ä¸‹**ï¼š

1. **å¤šçº§ç¼“å­˜å»¶è¿Ÿ**ï¼šEurekaæœ‰ä¸‰çº§ç¼“å­˜ï¼Œæ•°æ®åŒæ­¥æœ‰å»¶è¿Ÿ
2. **å®¢æˆ·ç«¯ç¼“å­˜**ï¼šå®¢æˆ·ç«¯æœ¬åœ°ç¼“å­˜é»˜è®¤30ç§’æ›´æ–°ä¸€æ¬¡
3. **æœåŠ¡ä¸‹çº¿æµç¨‹**ï¼šå®ä¾‹ä¸‹çº¿ â†’ Serveræ„ŸçŸ¥ â†’ ç¼“å­˜æ›´æ–° â†’ å®¢æˆ·ç«¯è·å–

**å»¶è¿Ÿæ—¶é—´åˆ†æ**ï¼š
```
æœåŠ¡ä¸‹çº¿ â†’ Eureka Serveræ„ŸçŸ¥ï¼ˆæœ€å¤š90ç§’ï¼‰
â†’ Serverç¼“å­˜æ›´æ–°ï¼ˆæœ€å¤š30ç§’ï¼‰  
â†’ å®¢æˆ·ç«¯æ‹‰å–æ›´æ–°ï¼ˆæœ€å¤š30ç§’ï¼‰
æ€»è®¡ï¼šæœ€é•¿å¯èƒ½å»¶è¿Ÿ150ç§’
```

**Eurekaçš„å¤„ç†æœºåˆ¶**ï¼š

1. **å®¢æˆ·ç«¯é‡è¯•æœºåˆ¶**
```java
@Component
public class ServiceCallHandler {
    
    @Retryable(
        value = {ConnectException.class, SocketTimeoutException.class},
        maxAttempts = 3,
        backoff = @Backoff(delay = 1000, multiplier = 2)
    )
    public String callService(String serviceName, String path) {
        List<ServiceInstance> instances = getAvailableInstances(serviceName);
        
        for (ServiceInstance instance : instances) {
            try {
                String url = "http://" + instance.getHost() + ":" + instance.getPort() + path;
                return restTemplate.getForObject(url, String.class);
            } catch (Exception e) {
                log.warn("è°ƒç”¨å®ä¾‹{}å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ªå®ä¾‹", instance.getInstanceId(), e);
                // æ ‡è®°å®ä¾‹ä¸ºä¸å¯ç”¨ï¼ˆæœ¬åœ°ä¸´æ—¶æ ‡è®°ï¼‰
                markInstanceDown(instance);
                continue;
            }
        }
        throw new ServiceUnavailableException("æ‰€æœ‰å®ä¾‹éƒ½ä¸å¯ç”¨");
    }
}
```

2. **å¿«é€Ÿæ•…éšœæ£€æµ‹**
```java
// Ribbonçš„å¥åº·æ£€æŸ¥
@Component
public class HealthCheckHandler {
    
    // å®¢æˆ·ç«¯ä¸»åŠ¨æ£€æŸ¥å®ä¾‹å¥åº·çŠ¶æ€
    public boolean isInstanceHealthy(ServiceInstance instance) {
        try {
            String healthUrl = "http://" + instance.getHost() + ":" 
                             + instance.getPort() + "/actuator/health";
            ResponseEntity<String> response = restTemplate.getForEntity(healthUrl, String.class);
            return response.getStatusCode().is2xxSuccessful();
        } catch (Exception e) {
            return false;
        }
    }
}
```

3. **å®¢æˆ·ç«¯ç†”æ–­é™çº§**
```java
@Component
public class CircuitBreakerService {
    
    @HystrixCommand(fallbackMethod = "fallbackMethod")
    public String callServiceWithCircuitBreaker(String serviceName) {
        // æœåŠ¡è°ƒç”¨é€»è¾‘
        return callRemoteService(serviceName);
    }
    
    public String fallbackMethod(String serviceName) {
        return "æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•";
    }
}
```

#### 4.2 è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶

**è§¦å‘æ¡ä»¶**ï¼šå½“Eureka Serveråœ¨çŸ­æ—¶é—´å†…ä¸¢å¤±è¿‡å¤šå®¢æˆ·ç«¯æ—¶

**ä¿æŠ¤æªæ–½**ï¼š
- ä¸å†åˆ é™¤æœåŠ¡å®ä¾‹ä¿¡æ¯
- ä»ç„¶èƒ½å¤Ÿæ¥å—æ–°çš„æ³¨å†Œä¿¡æ¯
- ä»ç„¶èƒ½å¤Ÿæä¾›æŸ¥è¯¢æœåŠ¡

**å®ç°åŸç†**ï¼š
```java
// è‡ªæˆ‘ä¿æŠ¤åˆ¤æ–­é€»è¾‘
public boolean isLeaseExpirationEnabled() {
    if (!isSelfPreservationModeEnabled()) {
        return true;
    }
    
    // è®¡ç®—æœŸæœ›çš„å¿ƒè·³æ•°
    int expectedNumberOfRenews = getExpectedNumberOfClientsSendingRenews();
    int threshold = (int) (expectedNumberOfRenews * serverConfig.getRenewalPercentThreshold());
    
    // å¦‚æœå®é™…å¿ƒè·³æ•°ä½äºé˜ˆå€¼ï¼Œå¼€å¯è‡ªæˆ‘ä¿æŠ¤
    return getNumOfRenewsInLastMin() > threshold;
}
```

#### 4.2 ç¼“å­˜æœºåˆ¶

**ä¸‰çº§ç¼“å­˜æ¶æ„**ï¼š
1. **readOnlyCacheMap**ï¼šåªè¯»ç¼“å­˜ï¼Œå®šæœŸæ›´æ–°
2. **readWriteCacheMap**ï¼šè¯»å†™ç¼“å­˜ï¼Œå®æ—¶æ›´æ–°
3. **registry**ï¼šå®é™…æ³¨å†Œè¡¨

**ç¼“å­˜æ›´æ–°æµç¨‹**ï¼š
```java
// è·å–æœåŠ¡åˆ—è¡¨çš„ç¼“å­˜é€»è¾‘
public Applications getApplications() {
    // å…ˆä»åªè¯»ç¼“å­˜è·å–
    Applications apps = readOnlyCacheMap.get(ALL_APPS);
    if (apps != null) {
        return apps;
    }
    
    // å†ä»è¯»å†™ç¼“å­˜è·å–
    apps = readWriteCacheMap.get(ALL_APPS);
    if (apps != null) {
        // æ›´æ–°åªè¯»ç¼“å­˜
        readOnlyCacheMap.put(ALL_APPS, apps);
        return apps;
    }
    
    // æœ€åä»æ³¨å†Œè¡¨è·å–
    apps = getApplicationsFromRegistry();
    readWriteCacheMap.put(ALL_APPS, apps);
    readOnlyCacheMap.put(ALL_APPS, apps);
    return apps;
}
```

#### 4.3 å‡å°‘æœåŠ¡ä¸‹çº¿å»¶è¿Ÿçš„ä¼˜åŒ–ç­–ç•¥

**ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–é…ç½®**ï¼š

1. **ç¼©çŸ­ç¼“å­˜æ›´æ–°é—´éš”**
```yaml
eureka:
  server:
    # ç¼©çŸ­åªè¯»ç¼“å­˜æ›´æ–°æ—¶é—´ï¼ˆé»˜è®¤30ç§’ï¼‰
    response-cache-update-interval-ms: 5000
    # å…³é—­åªè¯»ç¼“å­˜ï¼ˆå®æ—¶æ€§è¦æ±‚é«˜çš„åœºæ™¯ï¼‰
    use-read-only-response-cache: false
  
  client:
    # ç¼©çŸ­å®¢æˆ·ç«¯æ‹‰å–é—´éš”ï¼ˆé»˜è®¤30ç§’ï¼‰
    registry-fetch-interval-seconds: 5
    # ç¼©çŸ­å¿ƒè·³é—´éš”ï¼ˆé»˜è®¤30ç§’ï¼‰
    lease-renewal-interval-in-seconds: 10
    # ç¼©çŸ­æœåŠ¡å¤±æ•ˆæ—¶é—´ï¼ˆé»˜è®¤90ç§’ï¼‰
    lease-expiration-duration-in-seconds: 30
```

2. **ä¸»åŠ¨å¥åº·æ£€æŸ¥**
```java
@Component
public class ProactiveHealthChecker {
    
    @Scheduled(fixedRate = 5000) // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
    public void checkInstanceHealth() {
        List<ServiceInstance> instances = discoveryClient.getInstances("user-service");
        
        instances.parallelStream().forEach(instance -> {
            if (!isHealthy(instance)) {
                // ä¸»åŠ¨ä»æœ¬åœ°ç¼“å­˜ç§»é™¤ä¸å¥åº·å®ä¾‹
                removeFromLocalCache(instance);
                log.warn("å®ä¾‹{}å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå·²ä»æœ¬åœ°ç¼“å­˜ç§»é™¤", instance.getInstanceId());
            }
        });
    }
    
    private boolean isHealthy(ServiceInstance instance) {
        try {
            String healthUrl = buildHealthCheckUrl(instance);
            ResponseEntity<String> response = restTemplate.getForEntity(
                healthUrl, String.class);
            return response.getStatusCode().is2xxSuccessful();
        } catch (Exception e) {
            return false;
        }
    }
}
```

3. **æ™ºèƒ½é‡è¯•ä¸æ•…éšœè½¬ç§»**
```java
@Component
public class IntelligentRetryHandler {
    
    // å®ä¾‹å¥åº·çŠ¶æ€æœ¬åœ°ç¼“å­˜
    private final Map<String, Boolean> instanceHealthCache = new ConcurrentHashMap<>();
    
    public <T> T callWithIntelligentRetry(String serviceName, 
                                         Function<ServiceInstance, T> caller) {
        List<ServiceInstance> healthyInstances = getHealthyInstances(serviceName);
        
        for (ServiceInstance instance : healthyInstances) {
            try {
                T result = caller.apply(instance);
                // è°ƒç”¨æˆåŠŸï¼Œæ ‡è®°å®ä¾‹ä¸ºå¥åº·
                markInstanceHealthy(instance);
                return result;
            } catch (Exception e) {
                // è°ƒç”¨å¤±è´¥ï¼Œæ ‡è®°å®ä¾‹ä¸ºä¸å¥åº·
                markInstanceUnhealthy(instance);
                log.warn("è°ƒç”¨å®ä¾‹{}å¤±è´¥: {}", instance.getInstanceId(), e.getMessage());
                
                // å¦‚æœæ˜¯è¿æ¥ç±»å¼‚å¸¸ï¼Œç«‹å³å°è¯•ä¸‹ä¸€ä¸ªå®ä¾‹
                if (isConnectionException(e)) {
                    continue;
                }
            }
        }
        
        throw new ServiceUnavailableException("æ‰€æœ‰å®ä¾‹è°ƒç”¨å¤±è´¥");
    }
    
    private List<ServiceInstance> getHealthyInstances(String serviceName) {
        return discoveryClient.getInstances(serviceName)
            .stream()
            .filter(instance -> instanceHealthCache.getOrDefault(
                instance.getInstanceId(), true))
            .collect(Collectors.toList());
    }
}
```

## ğŸ†š ä¸»æµæ³¨å†Œä¸­å¿ƒå¯¹æ¯”

### 1. Eureka vs Nacos vs Consul

| ç‰¹æ€§ | Eureka | Nacos | Consul |
|------|--------|-------|--------|
| **ä¸€è‡´æ€§åè®®** | AP | CP + AP | CP |
| **å¥åº·æ£€æŸ¥** | å®¢æˆ·ç«¯å¿ƒè·³ | å¤šç§æ–¹å¼ | å¤šç§æ–¹å¼ |
| **è´Ÿè½½å‡è¡¡** | å®¢æˆ·ç«¯ | å®¢æˆ·ç«¯ | æœåŠ¡ç«¯ |
| **å¤šæ•°æ®ä¸­å¿ƒ** | æ”¯æŒ | æ”¯æŒ | æ”¯æŒ |
| **è·¨è¯­è¨€** | Javaä¸ºä¸» | å¤šè¯­è¨€ | å¤šè¯­è¨€ |
| **Spring Cloudé›†æˆ** | åŸç”Ÿæ”¯æŒ | å¾ˆå¥½ | è‰¯å¥½ |

### 2. CAPç†è®ºè§†è§’åˆ†æ

#### Eureka (AP)
- **å¯ç”¨æ€§ä¼˜å…ˆ**ï¼šå³ä½¿ç½‘ç»œåˆ†åŒºä¹Ÿèƒ½æä¾›æœåŠ¡
- **æœ€ç»ˆä¸€è‡´æ€§**ï¼šå„èŠ‚ç‚¹æ•°æ®æœ€ç»ˆä¼šåŒæ­¥
- **é€‚ç”¨åœºæ™¯**ï¼šå¯¹å¯ç”¨æ€§è¦æ±‚é«˜çš„åœºæ™¯

#### Nacos (CP + APå¯é€‰)
- **å¼ºä¸€è‡´æ€§æ¨¡å¼**ï¼šç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- **å¯ç”¨æ€§æ¨¡å¼**ï¼šç±»ä¼¼Eurekaçš„APæ¨¡å¼  
- **çµæ´»é…ç½®**ï¼šå¯æ ¹æ®éœ€æ±‚é€‰æ‹©æ¨¡å¼

**Nacos CPæ¨¡å¼å¼ºä¸€è‡´æ€§å®ç°åŸç†**ï¼š

1. **Raftåè®®ä¿è¯ä¸€è‡´æ€§**
```java
// Nacosä½¿ç”¨Raftåè®®å®ç°å¼ºä¸€è‡´æ€§
public class RaftConsistencyService {
    
    // Leaderé€‰ä¸¾æœºåˆ¶
    public void electLeader() {
        // 1. å€™é€‰è€…å‘èµ·æŠ•ç¥¨è¯·æ±‚
        // 2. è·å¾—å¤§å¤šæ•°èŠ‚ç‚¹æ”¯æŒæˆä¸ºLeader
        // 3. Leaderè´Ÿè´£æ¥æ”¶æ‰€æœ‰å†™è¯·æ±‚
        if (getCurrentTerm() < candidateTerm && !hasVotedInCurrentTerm()) {
            vote(candidateId);
        }
    }
    
    // æ—¥å¿—å¤åˆ¶æœºåˆ¶
    public boolean replicateLog(LogEntry entry) {
        // 1. Leaderæ¥æ”¶å†™è¯·æ±‚ï¼Œç”Ÿæˆæ—¥å¿—æ¡ç›®
        // 2. å¹¶è¡Œå‘æ‰€æœ‰Followerå‘é€æ—¥å¿—
        // 3. æ”¶åˆ°å¤§å¤šæ•°èŠ‚ç‚¹ç¡®è®¤åæäº¤
        int successCount = 0;
        for (Peer peer : peers) {
            if (peer.replicateEntry(entry)) {
                successCount++;
            }
        }
        
        // è¶…è¿‡åŠæ•°ç¡®è®¤æ‰æäº¤
        return successCount > peers.size() / 2;
    }
}
```

2. **æ•°æ®ä¸€è‡´æ€§ä¿è¯æµç¨‹**
```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant Leader as Nacos Leader
    participant F1 as Follower1  
    participant F2 as Follower2
    
    Client->>Leader: 1. æœåŠ¡æ³¨å†Œè¯·æ±‚
    Leader->>Leader: 2. ç”Ÿæˆæ—¥å¿—æ¡ç›®
    
    par å¹¶è¡Œå¤åˆ¶
        Leader->>F1: 3a. å¤åˆ¶æ—¥å¿—æ¡ç›®
        Leader->>F2: 3b. å¤åˆ¶æ—¥å¿—æ¡ç›®
    end
    
    par ç¡®è®¤å“åº”
        F1->>Leader: 4a. ç¡®è®¤æ”¶åˆ°
        F2->>Leader: 4b. ç¡®è®¤æ”¶åˆ°  
    end
    
    Leader->>Leader: 5. è¶…è¿‡åŠæ•°ç¡®è®¤ï¼Œæäº¤æ—¥å¿—
    Leader->>Client: 6. è¿”å›æˆåŠŸå“åº”
    
    par é€šçŸ¥æäº¤
        Leader->>F1: 7a. é€šçŸ¥æäº¤
        Leader->>F2: 7b. é€šçŸ¥æäº¤
    end
```

3. **ç½‘ç»œåˆ†åŒºå¤„ç†**
```java
// è„‘è£‚é¢„é˜²æœºåˆ¶
public class SplitBrainPrevention {
    
    public boolean canProcessWrite() {
        int aliveNodes = getAliveNodesCount();
        int totalNodes = getTotalNodesCount();
        
        // åªæœ‰å½“å­˜æ´»èŠ‚ç‚¹è¶…è¿‡åŠæ•°æ—¶æ‰èƒ½å¤„ç†å†™è¯·æ±‚
        return aliveNodes > totalNodes / 2;
    }
    
    // ç½‘ç»œåˆ†åŒºæ¢å¤åçš„æ•°æ®åŒæ­¥
    public void syncAfterPartitionRecover() {
        // 1. æ¯”è¾ƒå„èŠ‚ç‚¹çš„æ—¥å¿—
        // 2. ä»¥Leaderçš„æ—¥å¿—ä¸ºå‡†è¿›è¡ŒåŒæ­¥
        // 3. å›æ»šä¸ä¸€è‡´çš„æ•°æ®
        for (Peer peer : peers) {
            syncLogWithPeer(peer);
        }
    }
}
```

4. **CPæ¨¡å¼çš„æƒè¡¡**
- âœ… **ä¼˜åŠ¿**ï¼š
  - æ•°æ®å¼ºä¸€è‡´æ€§ï¼Œä¸ä¼šå‡ºç°è„è¯»
  - æœåŠ¡æ³¨å†Œä¿¡æ¯å®æ—¶åŒæ­¥
  - é€‚åˆå¯¹æ•°æ®å‡†ç¡®æ€§è¦æ±‚é«˜çš„åœºæ™¯

- âŒ **åŠ£åŠ¿**ï¼š
  - Leaderé€‰ä¸¾æœŸé—´æœåŠ¡ä¸å¯ç”¨
  - ç½‘ç»œåˆ†åŒºå¯èƒ½å¯¼è‡´æœåŠ¡ä¸­æ–­
  - å†™æ€§èƒ½ç›¸å¯¹è¾ƒä½ï¼ˆéœ€è¦å¤§å¤šæ•°èŠ‚ç‚¹ç¡®è®¤ï¼‰

5. **é…ç½®ç¤ºä¾‹**
```yaml
# Nacosé…ç½®æ–‡ä»¶
nacos:
  core:
    # é€‰æ‹©CPæ¨¡å¼ï¼ˆé»˜è®¤APæ¨¡å¼ï¼‰
    protocol:
      type: raft
      raft:
        # é€‰ä¸¾è¶…æ—¶æ—¶é—´
        election-timeout: 5000
        # å¿ƒè·³é—´éš”
        heartbeat-interval: 1000
```

#### Consul (CP)
- **å¼ºä¸€è‡´æ€§**ï¼šä½¿ç”¨Raftåè®®ä¿è¯ä¸€è‡´æ€§
- **å¯èƒ½ä¸å¯ç”¨**ï¼šLeaderé€‰ä¸¾æœŸé—´æœåŠ¡ä¸å¯ç”¨
- **é€‚ç”¨åœºæ™¯**ï¼šå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚ä¸¥æ ¼çš„åœºæ™¯

## ğŸš€ æœ€ä½³å®è·µ

### 1. æœåŠ¡æ³¨å†Œæœ€ä½³å®è·µ

#### å¥åº·æ£€æŸ¥é…ç½®
```java
@Component
public class CustomHealthIndicator implements HealthIndicator {
    @Override
    public Health health() {
        // è‡ªå®šä¹‰å¥åº·æ£€æŸ¥é€»è¾‘
        if (checkDatabaseConnection() && checkRedisConnection()) {
            return Health.up()
                .withDetail("database", "connected")
                .withDetail("redis", "connected")
                .build();
        } else {
            return Health.down()
                .withDetail("error", "External dependency failed")
                .build();
        }
    }
}
```

#### ä¼˜é›…åœæœº
```java
@PreDestroy
public void destroy() {
    // ä¼˜é›…åœæœºï¼šå…ˆä»æ³¨å†Œä¸­å¿ƒä¸‹çº¿ï¼Œå†åœæ­¢æœåŠ¡
    eurekaClient.shutdown();
    
    // ç­‰å¾…ä¸€æ®µæ—¶é—´è®©å®¢æˆ·ç«¯æ›´æ–°ç¼“å­˜
    try {
        Thread.sleep(30000);
    } catch (InterruptedException e) {
        Thread.currentThread().interrupt();
    }
}
```

### 2. æœåŠ¡å‘ç°æœ€ä½³å®è·µ

#### å®¢æˆ·ç«¯ç¼“å­˜ç­–ç•¥
```java
@Component
public class ServiceDiscoveryCache {
    private final LoadingCache<String, List<ServiceInstance>> cache;
    
    public ServiceDiscoveryCache() {
        this.cache = Caffeine.newBuilder()
            .maximumSize(1000)
            .expireAfterWrite(30, TimeUnit.SECONDS)
            .refreshAfterWrite(10, TimeUnit.SECONDS)
            .build(this::loadServiceInstances);
    }
    
    private List<ServiceInstance> loadServiceInstances(String serviceName) {
        return discoveryClient.getInstances(serviceName);
    }
}
```

#### è´Ÿè½½å‡è¡¡ä¸å®¹é”™
```java
@Component
public class ResilientServiceCaller {
    
    @Retryable(value = {Exception.class}, maxAttempts = 3)
    public String callService(String serviceName, String path) {
        List<ServiceInstance> instances = getHealthyInstances(serviceName);
        
        for (ServiceInstance instance : instances) {
            try {
                return restTemplate.getForObject(
                    buildUrl(instance, path), String.class);
            } catch (Exception e) {
                log.warn("Failed to call instance: {}", instance.getUri(), e);
                // å°è¯•ä¸‹ä¸€ä¸ªå®ä¾‹
            }
        }
        
        throw new ServiceUnavailableException("No healthy instance available");
    }
}
```

## ğŸ“ é¢è¯•è¦ç‚¹æ€»ç»“

### æ ‡å‡†å›ç­”æ¨¡æ¿ï¼šæœåŠ¡æ³¨å†Œå‘ç°æµç¨‹

**æœåŠ¡æ³¨å†Œæµç¨‹**ï¼š
1. æœåŠ¡å¯åŠ¨æ—¶ï¼Œè¯»å–é…ç½®ä¿¡æ¯ï¼ˆæœåŠ¡åã€IPã€ç«¯å£ç­‰ï¼‰
2. å‘Eureka Serverå‘é€æ³¨å†Œè¯·æ±‚ï¼ŒåŒ…å«æœåŠ¡å®ä¾‹ä¿¡æ¯
3. Eureka Serverå°†æœåŠ¡ä¿¡æ¯å­˜å‚¨åœ¨å†…å­˜æ³¨å†Œè¡¨ä¸­
4. æœåŠ¡å®šæœŸï¼ˆé»˜è®¤30ç§’ï¼‰å‘Eureka Serverå‘é€å¿ƒè·³ä¿æ´»
5. å¦‚æœå¿ƒè·³è¶…æ—¶ï¼ˆé»˜è®¤90ç§’ï¼‰ï¼ŒEureka Serverä¼šåˆ é™¤è¯¥å®ä¾‹

**æœåŠ¡å‘ç°æµç¨‹**ï¼š
1. å®¢æˆ·ç«¯å‘Eureka Serverå‘é€æŸ¥è¯¢è¯·æ±‚
2. Eureka Serverè¿”å›æœåŠ¡å®ä¾‹åˆ—è¡¨
3. å®¢æˆ·ç«¯å°†å®ä¾‹åˆ—è¡¨ç¼“å­˜åˆ°æœ¬åœ°ï¼ˆé»˜è®¤30ç§’æ›´æ–°ä¸€æ¬¡ï¼‰
4. å®¢æˆ·ç«¯ä½¿ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•é€‰æ‹©ä¸€ä¸ªå®ä¾‹
5. ç›´æ¥è°ƒç”¨é€‰ä¸­çš„æœåŠ¡å®ä¾‹

### å…³é”®æŠ€æœ¯ç‚¹

1. **å¿ƒè·³æœºåˆ¶**ï¼šæœåŠ¡æ¯30ç§’å‘é€å¿ƒè·³ï¼Œ90ç§’æ— å¿ƒè·³åˆ™å‰”é™¤
2. **è‡ªæˆ‘ä¿æŠ¤**ï¼šç½‘ç»œæ•…éšœæ—¶ä¸è½»æ˜“å‰”é™¤æœåŠ¡ï¼Œä¿è¯å¯ç”¨æ€§
3. **ä¸‰çº§ç¼“å­˜**ï¼šæé«˜æŸ¥è¯¢æ€§èƒ½ï¼Œä½†ä¼šæœ‰æ•°æ®å»¶è¿Ÿ
4. **å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡**ï¼šRibbonå®ç°è½®è¯¢ã€éšæœºç­‰ç­–ç•¥

### å¸¸è§é¢è¯•è¿½é—®

**Q: Eurekaå¦‚ä½•å¤„ç†ç½‘ç»œåˆ†åŒºï¼Ÿ**
A: é€šè¿‡è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ï¼Œå½“å¿ƒè·³å¤±è´¥ç‡è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œæš‚åœå‰”é™¤æœåŠ¡å®ä¾‹ï¼Œä¿è¯APï¼ˆé«˜å¯ç”¨ï¼‰ã€‚

**Q: ä¸ºä»€ä¹ˆé€‰æ‹©Eurekaè€Œä¸æ˜¯Zookeeperï¼Ÿ**
A: Eurekaé‡‡ç”¨APæ¨¡å¼ï¼Œæ³¨é‡å¯ç”¨æ€§ï¼›Zookeeperé‡‡ç”¨CPæ¨¡å¼ï¼Œæ³¨é‡ä¸€è‡´æ€§ã€‚å¾®æœåŠ¡åœºæ™¯ä¸‹ï¼ŒæœåŠ¡å¯ç”¨æ€§æ¯”æ•°æ®ä¸€è‡´æ€§æ›´é‡è¦ã€‚

**Q: å¦‚æœæœåŠ¡Bä¸‹çº¿äº†ï¼Œä½†æœåŠ¡Açš„æœ¬åœ°ç¼“å­˜è¿˜æ²¡æ›´æ–°ï¼Œè¿™æ—¶è°ƒç”¨ä¼šæ€æ ·ï¼Ÿ**
A: è¿™ç§æƒ…å†µç¡®å®ä¼šå‘ç”Ÿï¼Œå› ä¸ºEurekaæœ‰å¤šçº§ç¼“å­˜å»¶è¿Ÿã€‚è§£å†³æ–¹æ¡ˆï¼š
1. å®¢æˆ·ç«¯é‡è¯•æœºåˆ¶ï¼šè°ƒç”¨å¤±è´¥åè‡ªåŠ¨é‡è¯•å…¶ä»–å®ä¾‹
2. å¥åº·æ£€æŸ¥ï¼šä¸»åŠ¨æ£€æµ‹å®ä¾‹çŠ¶æ€å¹¶æ›´æ–°æœ¬åœ°ç¼“å­˜
3. ç†”æ–­é™çº§ï¼šä½¿ç”¨Hystrixç­‰å·¥å…·æä¾›é™çº§æ–¹æ¡ˆ
4. ä¼˜åŒ–é…ç½®ï¼šç¼©çŸ­ç¼“å­˜æ›´æ–°é—´éš”ï¼Œå‡å°‘å»¶è¿Ÿæ—¶é—´

**Q: Nacosçš„CPæ¨¡å¼æ˜¯å¦‚ä½•ä¿è¯å¼ºä¸€è‡´æ€§çš„ï¼Ÿ**
A: Nacosä½¿ç”¨Raftåè®®å®ç°å¼ºä¸€è‡´æ€§ï¼š
1. Leaderé€‰ä¸¾ï¼šåªæœ‰ä¸€ä¸ªLeaderå¤„ç†å†™è¯·æ±‚
2. æ—¥å¿—å¤åˆ¶ï¼šLeaderå°†æ“ä½œæ—¥å¿—å¤åˆ¶åˆ°å¤§å¤šæ•°Follower
3. æäº¤ç¡®è®¤ï¼šè¶…è¿‡åŠæ•°èŠ‚ç‚¹ç¡®è®¤åæ‰æäº¤äº‹åŠ¡
4. è„‘è£‚é¢„é˜²ï¼šç½‘ç»œåˆ†åŒºæ—¶ï¼Œåªæœ‰å¤§å¤šæ•°èŠ‚ç‚¹çš„åˆ†åŒºæ‰èƒ½æä¾›æœåŠ¡

**Q: å¦‚ä½•è§£å†³Eurekaçš„æ•°æ®å»¶è¿Ÿé—®é¢˜ï¼Ÿ**
A: 1ï¼‰ç¼©çŸ­ç¼“å­˜æ›´æ–°é—´éš”ï¼›2ï¼‰ä½¿ç”¨å¥åº·æ£€æŸ¥ï¼›3ï¼‰å®¢æˆ·ç«¯å®ç°é‡è¯•æœºåˆ¶ï¼›4ï¼‰è€ƒè™‘å‡çº§åˆ°Nacosç­‰æ–°ä¸€ä»£æ³¨å†Œä¸­å¿ƒã€‚

---

**ğŸ¯ å­¦ä¹ æ£€éªŒ**ï¼šèƒ½å¦æµç•…åœ°æè¿°æœåŠ¡æ³¨å†Œå‘ç°çš„å®Œæ•´æµç¨‹ï¼ŒåŒ…æ‹¬å…³é”®å‚æ•°å’Œå®¹é”™æœºåˆ¶ï¼Ÿ 